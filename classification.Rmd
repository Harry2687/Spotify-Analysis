---
title: "Classification Analysis"
author: "Harry Zhong"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
source("scripts/packages.R")
```

```{r}
track_features <- read_csv("data/feature_data/track_features.csv")

full_track_features <- read_csv("data/feature_data/full_track_features.csv") %>%
  rename(trackName = "track_name",
         artistName = "artist_name",
         trackID = "track_uri")

kaggle_dataset <- read_csv("kaggle_dataset.csv") %>%
  rename(trackName = "track_name",
         artistName = "artists",
         trackID = "track_id",
         index = 1) %>%
  select(-album_name,
         -popularity,
         -explicit, 
         -index, 
         -track_genre) %>%
  distinct(trackName, .keep_all = TRUE) %>%
  slice(1:100)
```

```{r}
feature_matrix <- full_track_features %>%
  mutate(track_artist = paste(trackName, artistName, sep = " - ")) %>%
  select(-trackName, -artistName) %>%
  column_to_rownames(var = "track_artist") %>%
  select(-trackID,
         -key,
         -mode,
         -time_signature) %>%
  scale()

n_clusters <- fviz_nbclust(feature_matrix, 
                           kmeans,
                           nstart = 20,
                           iter.max = 100)[["data"]] %>%
  slice(which.max(y)) %>% 
  select(clusters) %>%
  as.numeric()

km <- feature_matrix %>%
  kmeans(centers = n_clusters) 

fviz_cluster(km,
             data = feature_matrix, 
             geom = "point", 
             ellipse.type = "convex", 
             ggtheme = theme_bw())
```

```{r}
kmeans_select_features <- function(n, data, nstart, itermax) {
  n_factors <- n
  
  comb_n <- data %>%
    colnames() %>%
    combn(n_factors, simplify = FALSE)
  
  old_cols = seq(1, n_factors)
  new_cols = paste0("factor_", seq(1, n_factors))
  
  new_cols_sym <- syms(new_cols)
  
  factor_combinations_n <- do.call(rbind.data.frame, comb_n) %>%
    rename_with(~new_cols, all_of(old_cols)) %>%
    mutate(factors = pmap(list(!!!new_cols_sym), c)) %>%
    select(-(!!new_cols)) %>%
    mutate(data = map(factors,
                      ~data %>%
                        as.data.frame() %>%
                        select(all_of(.x)))) %>%
    mutate(n_clusters = map(data,
                            ~fviz_nbclust(.x, 
                                          kmeans, 
                                          nstart = nstart, 
                                          iter.max = itermax)[["data"]] %>%
                              slice(which.max(y)) %>%
                              select(clusters) %>%
                              as.numeric(),
                            .progress = paste("Finding optimal n_clusters:", 
                                              n_factors, 
                                              "factors")) %>%
             as.numeric()) %>% 
    mutate(km = map2(data,
                     n_clusters,
                     ~kmeans(.x, 
                             .y, 
                             nstart = nstart, 
                             iter.max = itermax,
                             algorithm = "MacQueen"),
                     .progress = paste("Calculating kmeans:", 
                                       n_factors, 
                                       "factors"))) %>%
    mutate(total_withinss = map(km,
                                ~.x$tot.withinss) %>%
             as.numeric()) %>%
    mutate(km_plot = map2(km,
                          data,
                          ~fviz_cluster(.x,
                                        data = .y,
                                        geom = "point",
                                        ellipse.type = "convex",
                                        ggtheme = theme_bw()))) %>%
    arrange(total_withinss)  
  
  return(factor_combinations_n)
}
```

```{r}
set.seed(2687)

kmeans_2fact <- kmeans_select_features(2, feature_matrix, 25, 1000)

for (i in 1:20) {
  kmeans_2fact %>%
    slice(i) %>%
    pull(km_plot) %>%
    print()
}
```

```{r}
set.seed(2687)

cl <- makeCluster(detectCores())
registerDoParallel(cl)

factor_combinations_n <- foreach(n = seq(2, 3),
                                 .packages = c("tidyverse",
                                               "cluster",
                                               "factoextra",
                                               "rlang"),
                                 .combine = bind_rows) %dopar% {
                                   kmeans_select_features(n, feature_matrix, 25, 1000)
                                 } %>% 
  arrange(total_withinss)

stopCluster(cl)

for (i in 1:20) {
  factor_combinations_n %>%
    slice(i) %>%
    pull(km_plot) %>%
    print()
}
```

