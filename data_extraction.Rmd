---
title: "Data Extraction"
author: "Harry Zhong"
date: '`r Sys.Date()`'
output: html_document
---

```{r}
source("scripts/packages.R")
source("scripts/api_functions.R")
```

Extract streaming history data from .json files.

```{r}
files <- list.files(paste0(here(), "/data/history_data"), 
                    pattern = "*.json", 
                    full.names = TRUE)

streaming_history <- foreach(file = files, 
                                  .packages = c("jsonlite"),
                                  .combine = rbind) %do% {
  fromJSON(file, flatten = TRUE)
} %>%
  mutate(endTime = endTime %>%
           substring(1, 7) %>%
           paste0("-01") %>%
           ymd()) %>%
  rename(month = endTime)
```

Get Spotify token from API.

```{r}
source("scripts/generate_token.R")
```

Match artists to genres using API functions.

```{r}
artist_genres <- streaming_history %>% 
  select(artistName) %>%
  distinct() %>%
  mutate(
    artistID = map(artistName,
                   ~search_artist(.x),
                   .progress = "Searching Artist IDs"
                   )
  ) %>%
  mutate(
    genre = map(artistID,
                ~get_genres(.x),
                .progress = "Getting Artist Genres"
                )
  )
```

Match tracks to stuff using API functions.

```{r}
track_features <- streaming_history %>%
  select(artistName, trackName) %>%
  distinct() %>%
  mutate(
    trackID = map2(artistName,
                   trackName,
                   ~search_track(.y, .x),
                   .progress = "Searching Track IDs"
                   )
  ) %>%
  mutate(
    audio_features = map(trackID,
                         ~get_audio_features(.x),
                         .progress = "Getting Audio Features"
                         )
  )

n_error <- track_features %>%
  filter(map_lgl(audio_features, ~"error" %in% names(.x))) %>%
  nrow()

track_features <- track_features %>%
  filter(!map_lgl(audio_features, ~"error" %in% names(.x)))

while (n_error > 0) {
  source("scripts/generate_token.R")
  
  track_features_2 <- track_features %>%
    filter(map_lgl(audio_features, ~"error" %in% names(.x))) %>% 
    mutate(
      audio_features = map(trackID,
                           ~get_audio_features(.x),
                           .progress = "Getting Audio Features"
                           )
    )
  
  track_features <- bind_rows(track_features,
                              track_features_2)
  
  n_error <- track_features %>%
    filter(map_lgl(audio_features, ~"error" %in% names(.x))) %>%
    nrow()
  
  track_features <- track_features %>%
    filter(!map_lgl(audio_features, ~"error" %in% names(.x)))
  
  print(paste0("n_error: ", n_error))
}
```

```{r}
track_features_wide <- track_features %>%
  filter(trackID != "NULL") %>%
  mutate(label = map(audio_features, names)) %>%
  unnest(c(audio_features, label)) %>%
  mutate(audio_features = unlist(audio_features),
         trackID = unlist(trackID)) %>%
  pivot_wider(names_from = label, values_from = audio_features) %>%
  select(artistName,
         trackName,
         trackID,
         danceability,
         energy,
         key,
         loudness,
         mode,
         speechiness,
         acousticness,
         instrumentalness,
         liveness,
         valence,
         tempo,
         duration_ms,
         time_signature) %>%
  mutate(danceability = as.numeric(danceability),
         energy = as.numeric(energy),
         key = as.numeric(key),
         loudness = as.numeric(loudness),
         mode = as.numeric(mode),
         speechiness = as.numeric(speechiness),
         acousticness = as.numeric(acousticness),
         instrumentalness = as.numeric(instrumentalness),
         liveness = as.numeric(liveness),
         valence = as.numeric(valence),
         tempo = as.numeric(tempo),
         duration_ms = as.numeric(duration_ms),
         time_signature = as.numeric(time_signature))

write.csv(track_features_wide, file = "track_features.csv", row.names = FALSE)
```

